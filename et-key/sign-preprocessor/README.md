# Signè¨€èªžãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µï½žã‚³ãƒ³ãƒ‘ã‚¤ãƒ©

Signè¨€èªžã‚³ãƒ¼ãƒ‰ã®å‰å‡¦ç†ã‹ã‚‰ARM64ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¾ã§ã‚’è¡Œã†çµ±åˆé–‹ç™ºç’°å¢ƒã§ã™ã€‚

## ðŸŒŸ ç‰¹å¾´

- **æ®µéšŽçš„ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°**: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ â†’ å¼•æ•°æ›¸ãæ›ãˆ â†’ matchcaseå¤‰æ›
- **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–è¨­è¨ˆ**: å„å‡¦ç†æ®µéšŽãŒç‹¬ç«‹ã—ãŸPEGãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- **å®Œå…¨ãªæ§‹æ–‡è§£æž**: Signè¨€èªžå°‚ç”¨ã®é«˜é€Ÿãƒ‘ãƒ¼ã‚µãƒ¼ (16æ®µéšŽâ†’6æ®µéšŽå„ªå…ˆé †ä½)
- **ARM64ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**: ã‚¹ã‚¿ãƒƒã‚¯ãƒžã‚·ãƒ³ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©
- **ãƒ‡ãƒãƒƒã‚°æ”¯æ´**: å„æ®µéšŽã®ä¸­é–“çµæžœã‚’ä¿å­˜ãƒ»ç¢ºèªå¯èƒ½

## ðŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
sign-preprocessor/
â”œâ”€â”€ sign-preprocessor.js       # ãƒ¡ã‚¤ãƒ³çµ±åˆå‡¦ç† (ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹ + æ§‹æ–‡è§£æž)
â”œâ”€â”€ modules/                   # PEGãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¾¤
â”‚   â”œâ”€â”€ formatter.pegjs        # ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆæ•´å½¢
â”‚   â”œâ”€â”€ arg-rewriter.pegjs     # å¼•æ•°åâ†’ä½ç½®ãƒ™ãƒ¼ã‚¹å¤‰æ› 
â”‚   â”œâ”€â”€ matchcase-rewriter.pegjs # matchcaseâ†’çŸ­çµ¡è©•ä¾¡å¤‰æ›
â”‚   â””â”€â”€ sign-parser.pegjs      # Signè¨€èªžæ§‹æ–‡è§£æžå™¨
â”œâ”€â”€ compiler/                  # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©éƒ¨åˆ†
â”‚   â”œâ”€â”€ run-test.js           # ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”œâ”€â”€ sign-stack-compiler.js # AArch64ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©æœ¬ä½“
â”‚   â”œâ”€â”€ test-input.json       # ãƒ†ã‚¹ãƒˆç”¨JSONå…¥åŠ›
â”‚   â”œâ”€â”€ output.s              # ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â””â”€â”€ asm_compile.bat       # æœ€çµ‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒãƒƒãƒ
â”œâ”€â”€ example/                   # ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨å¤‰æ›çµæžœ
â”œâ”€â”€ test/                      # å˜ä½“ãƒ†ã‚¹ãƒˆ
â””â”€â”€ README.md
```

## ðŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚° + æ§‹æ–‡è§£æž

Signè¨€èªžã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹ã—ã¦JSON ASTã«å¤‰æ›ï¼š

```bash
# åŸºæœ¬çš„ãªå¤‰æ› (JSONå‡ºåŠ›)
node sign-preprocessor.js input.sn output.json

# ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹çµæžœã‚‚ä¿å­˜
node sign-preprocessor.js input.sn output.json preprocessed.sn

# ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚µã®ã¿å®Ÿè¡Œ
node sign-preprocessor.js input.sn null preprocessed.sn

# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
node sign-preprocessor.js input.sn output.json preprocessed.sn --debug
```

### 2. ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

JSON ASTã‹ã‚‰ARM64ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼š

```bash
cd compiler
node run-test.js
```

**å‰ææ¡ä»¶**: `test-input.json` ã«æœ‰åŠ¹ãªSignè¨€èªžASTãŒå¿…è¦
**å‡ºåŠ›**: `output.s` (ARM64ã‚¢ã‚»ãƒ³ãƒ–ãƒªãƒ•ã‚¡ã‚¤ãƒ«)

### 3. æœ€çµ‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

WSLã‚’ä½¿ç”¨ã—ã¦ARM64å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼š

```bash
cd compiler
asm_compile.bat
```

**å‰ææ¡ä»¶**: 
- WSLç’°å¢ƒ
- ARM64ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ© (`aarch64-linux-gnu-as`, `aarch64-linux-gnu-ld`)

**å‡ºåŠ›**: `output` (ARM64å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«)

## ðŸ”„ å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹

```bash
# 1. Signè¨€èªžã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹ + JSONå¤‰æ›(compilerç›´ä¸‹ã«ç›´æŽ¥å‡ºåŠ›Ver)
node sign-preprocessor.js .\example\test-input.sn .\compiler\test-input.json .\example\test-input_preprocessed.sn 

# 2. ã‚¢ã‚»ãƒ³ãƒ–ãƒªç”Ÿæˆ
node .\compiler\run-test.js  

# 3. æœ€çµ‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
.\compiler\asm_compile.bat

```

## ðŸ“‹ ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°å‡¦ç†æ®µéšŽ

### 1. ãƒ•ã‚©ãƒ¼ãƒžãƒƒã‚¿ãƒ¼ (`formatter.pegjs`)
æ¼”ç®—å­ã®å‰å¾Œã«é©åˆ‡ãªç©ºç™½ã‚’è‡ªå‹•æŒ¿å…¥
```sign
// å…¥åŠ›
add:x y?x+y

// å‡ºåŠ›  
add : x y ? x + y
```

### 2. å¼•æ•°æ›¸ãæ›ãˆ (`arg-rewriter.pegjs`)
å¼•æ•°åã‚’ä½ç½®ãƒ™ãƒ¼ã‚¹(`_0`, `_1`)ã«å¤‰æ›
```sign
// å…¥åŠ›
add : x y ? x + y

// å‡ºåŠ›
add : _0 _1 ? _0 + _1
```

### 3. matchcaseæ›¸ãæ›ãˆ (`matchcase-rewriter.pegjs`)
æ¡ä»¶åˆ†å²ã‚’çŸ­çµ¡è©•ä¾¡ãƒã‚§ãƒ¼ãƒ³ã«å¤‰æ›
```sign
// å…¥åŠ›
classify : _0 ?
    _0 = 0 : 'zero'
    _0 > 0 : 'positive'
    _0 < 0 : 'negative'

// å‡ºåŠ›
classify : _0 ?
    _0 = 0 & 'zero' |
    _0 > 0 & 'positive' |
    _0 < 0 & 'negative'
```

### 4. æ§‹æ–‡è§£æž (`sign-parser.pegjs`)
ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹æ¸ˆã¿ã‚³ãƒ¼ãƒ‰ã‚’JSONã®ASTã«å¤‰æ›

## ðŸ§ª ãƒ†ã‚¹ãƒˆ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm test

# å€‹åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
npm run test:arg-rewriter
npm run test:matchcase

# çµ±åˆãƒ‡ãƒ¢
npm run demo
```

## âš™ï¸ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©è©³ç´°

### Sign Stack Compiler

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ARM64 (AArch64)
**è¨­è¨ˆ**: ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¿ãƒƒã‚¯ + ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯åˆ†é›¢
- ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¿ãƒƒã‚¯: X8-X15ãƒ¬ã‚¸ã‚¹ã‚¿
- ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯: æ¨™æº–SPãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ãƒƒã‚¯
- Unitå€¤å‡¦ç†: XZRãƒ¬ã‚¸ã‚¹ã‚¿ä½¿ç”¨

**å¯¾å¿œæ©Ÿèƒ½**:
- âœ… åŸºæœ¬ç®—è¡“æ¼”ç®— (`+`, `-`, `*`, `/`, `%`)
- âœ… é–¢æ•°å®šç¾©ãƒ»å‘¼ã³å‡ºã—
- âœ… Unitå€¤å‡¦ç†
- âœ… å®‰å…¨é™¤ç®— (ã‚¼ãƒ­é™¤ç®—å¯¾ç­–)
- ðŸš§ ãƒã‚¤ãƒ³ãƒˆãƒ¬ã‚¹è¨˜æ³• (Phase 4äºˆå®š)
- ðŸš§ é«˜éšŽé–¢æ•° (Phase 5äºˆå®š)

## ðŸ”§ ç’°å¢ƒè¦ä»¶

### é–‹ç™ºç’°å¢ƒ
- Node.js 12+
- npm

### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç’°å¢ƒ (Windows)
- WSL (Windows Subsystem for Linux)
- ARM64ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©:
  ```bash
  sudo apt-get install gcc-aarch64-linux-gnu
  ```

## ðŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **WSLã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼**
   ```
   aarch64-linux-gnu-as: command not found
   ```
   **è§£æ±º**: ARM64ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

2. **ãƒ—ãƒªãƒ—ãƒ­ã‚»ãƒƒã‚·ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼**
   ```
   æ§‹æ–‡è§£æžã‚¨ãƒ©ãƒ¼: Unexpected character
   ```
   **è§£æ±º**: Signè¨€èªžã®æ§‹æ–‡ã‚’ç¢ºèªã€æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¯`` ` ``ã§å›²ã‚€

3. **ã‚¢ã‚»ãƒ³ãƒ–ãƒªç”Ÿæˆã‚¨ãƒ©ãƒ¼**
   ```
   test-input.json not found
   ```
   **è§£æ±º**: æœ‰åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦

## ðŸ“š é–¢é€£ãƒªãƒ³ã‚¯

- [Signè¨€èªžä»•æ§˜æ›¸](./reference/Sign_reference_ja-jp.md)
- [ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©è¨­è¨ˆè³‡æ–™](./reference/Hint/)
- [PEG.jså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://pegjs.org/documentation)

